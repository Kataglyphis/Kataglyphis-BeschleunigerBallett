name: Linux build reusable

on:
  workflow_call:
    inputs:
      runner:
        required: true
        type: string
    secrets:
      SERVER:
        required: true
      USERNAME:
        required: true
      PW:
        required: true
      CODECOV_TOKEN:
        required: true

env:
  BUILD_TYPE: Debug
  VULKAN_VERSION: 1.4.321.1

jobs:

  build_and_test:
    strategy:
      matrix:
        compiler: [clang, gcc]

    runs-on: ${{ inputs.runner }}

    steps:
      - uses: actions/checkout@v5.0.0
        with:
          submodules: recursive

      - name: Remove too old CMake
        run: |
          which cmake || true
          sudo rm -f /usr/local/bin/cmake || true
          sudo apt-get purge --auto-remove -y cmake || true

      - name: Install deps (heavy)
        run: |
          sudo chmod +x Scripts/Linux/setup-dependencies.sh
          sudo ./Scripts/Linux/setup-dependencies.sh ${{ env.VULKAN_VERSION }}

      - name: (ARM) prepare PATH hint
        if: ${{ inputs.runner == 'ubuntu-24.04-arm' }}
        run: |
          echo "ARM SDK will be at ${{ github.workspace }}/${{ env.VULKAN_VERSION }}/aarch64/bin"

      - name: Check Installation and update path
        if: inputs.runner == 'ubuntu-24.04-arm'
        run: |
          echo "${{ github.workspace }}/${{ env.VULKAN_VERSION }}/aarch64/bin" >> $GITHUB_PATH

      - name: Update path and Vulkan env vars
        run: |
          source "${{ github.workspace }}/${{ env.VULKAN_VERSION }}/setup-env.sh"
          which glslc
          echo "/usr/bin" >> $GITHUB_PATH
          cmake --version

      - name: Make directory
        run: |
          rm -rf build
          mkdir build
          
      - name: Set PRESET for compiler
        run: |
          if [ "${{ matrix.compiler }}" = "clang" ]; then
            echo "PRESET=linux-debug-clang" >> $GITHUB_ENV
          else
            echo "PRESET=linux-debug-GNU" >> $GITHUB_ENV
          fi

      - name: Build
        run: |
          source "${{ github.workspace }}/${{ env.VULKAN_VERSION }}/setup-env.sh"
          # use the preset chosen above
          cmake -B build --preset "$PRESET"
          cmake --build ${{ github.workspace }}/build --preset "$PRESET"

      - name: Test
        if: ${{ matrix.compiler == 'clang' }}
        working-directory: ${{github.workspace}}/build/
        run: ctest -C ${{env.BUILD_TYPE}} --verbose --extra-verbose --debug -T test --output-on-failure -E Integration.VulkanEngine RendererTest.BasicSetup

      - name: Build Code Coverage
        if: ${{ matrix.compiler == 'clang' }}
        run: |
          llvm-profdata merge -sparse ${{github.workspace}}/build/Test/compile/default.profraw -o ${{github.workspace}}/build/compileTestSuite.profdata
          llvm-cov report ${{github.workspace}}/build/compileTestSuite -instr-profile=${{github.workspace}}/build/compileTestSuite.profdata
          llvm-cov export ${{github.workspace}}/build/compileTestSuite -format=text -instr-profile=${{github.workspace}}/build/compileTestSuite.profdata > ${{github.workspace}}/build/coverage.json
          llvm-cov show ${{github.workspace}}/build/compileTestSuite -instr-profile=${{github.workspace}}/build/compileTestSuite.profdata

      - name: Set up Python 3.13
        if: ${{ matrix.compiler == 'clang' }}
        uses: actions/setup-python@v6.0.0
        with:
          python-version: "3.13"
      # You can test your matrix by printing the current Python version
      - name: Setup python env
        if: ${{ matrix.compiler == 'clang' }}
        run: |
          pip install -r requirements.txt

      - name: Build web page
        if: ${{ matrix.compiler == 'clang' }}
        run: |
          cp ${{github.workspace}}/build/build/html/*.svg ./docs/source/_static
          cd docs/source
          python graphviz_generator.py 
          cd ..
          make html

      - name: ðŸ“‚ Sync files to domain
        uses: SamKirkland/FTP-Deploy-Action@v4.3.6
        if: ${{ matrix.compiler == 'clang' && inputs.runner == 'ubuntu-24.04' }}
        with:
          server: ${{ secrets.SERVER }}
          username: ${{ secrets.USERNAME }}
          password: ${{ secrets.PW }}
          local-dir: "./docs/build/html/"

      - name: Codecov
        if: ${{ matrix.compiler == 'clang' && inputs.runner == 'ubuntu-24.04' }}
        uses: codecov/codecov-action@v5.5.1
        with:
          token: ${{ secrets.CODECOV_TOKEN }}
          files: ${{github.workspace}}/build/coverage.json
          name: codecov-umbrella
          fail_ci_if_error: false
          verbose: false

  release_package:
    needs: [build_and_test,]
    runs-on: ${{ inputs.runner }}
    # optionally: only run release packaging for a specific runner:
    # if: ${{ inputs.runner == 'ubuntu-24.04' }}
    steps:
      - uses: actions/checkout@v5.0.0
        with:
          submodules: recursive
      
      - name: Remove too old CMake
        run: |
          which cmake || true
          sudo rm -f /usr/local/bin/cmake || true
          sudo apt-get purge --auto-remove -y cmake || true

      - name: Install deps (heavy)
        run: |
          sudo chmod +x Scripts/Linux/setup-dependencies.sh
          sudo ./Scripts/Linux/setup-dependencies.sh ${{ env.VULKAN_VERSION }}

      - name: (ARM) prepare PATH hint
        if: ${{ inputs.runner == 'ubuntu-24.04-arm' }}
        run: |
          echo "ARM SDK will be at ${{ github.workspace }}/${{ env.VULKAN_VERSION }}/aarch64/bin"

      - name: Make directory
        run: |
          rm -rf build
          mkdir build

      - name: Update path
        run: |
          echo "/usr/bin" >> $GITHUB_PATH
          cmake --version
          
      - name: Configure CMake for Release
        run: |
          source "${{ github.workspace }}/${{ env.VULKAN_VERSION }}/setup-env.sh"
          cmake -B build-release --preset linux-release-clang

      - name: Build Release
        run: |
          source "${{ github.workspace }}/${{ env.VULKAN_VERSION }}/setup-env.sh"
          export CMAKE_BUILD_PARALLEL_LEVEL=$(nproc)
          cmake --build build-release --config Release

      - name: Package
        run: |
          source "${{ github.workspace }}/${{ env.VULKAN_VERSION }}/setup-env.sh"
          cmake --build build-release --target package

      - name: Upload Linux Packages (Clang only)
        uses: actions/upload-artifact@v4
        with:
          name: linux-packages
          path: |
            build-release/*.tar.gz
            build-release/*.tgz
            build-release/*.deb

name: Linux build reusable

on:
  workflow_call:
    inputs:
      runner:
        required: true
        type: string
    secrets:
      SERVER:
        required: true
      USERNAME:
        required: true
      PW:
        required: true
      CODECOV_TOKEN:
        required: true
      GHCR_PAT:
        required: true

env:
  BUILD_TYPE: Debug
  GCC_PROFILE_PRESET: linux-profile-GNU
  CLANG_PROFILE_PRESET: linux-profile-clang
  VULKAN_VERSION: 1.4.321.1
  # folder/name configuration -- change here to affect the whole workflow
  BUILD_DIR: build
  BUILD_RELEASE_DIR: build-release
  DOCS_OUT: build/build/html
  COVERAGE_JSON: build/coverage.json

jobs:

  build_and_test:
    strategy:
      matrix:
        compiler: [clang, gcc]

    runs-on: ${{ inputs.runner }}

    # Run this job inside the GHCR container:
    container:
      image: ghcr.io/kataglyphis/kataglyphis_beschleuniger:latest
      credentials:
        username: ${{ github.actor }}
        password: ${{ secrets.GHCR_PAT }}
      options: >-
        --user root
        ${{ contains(inputs.runner, 'arm') && '--platform linux/arm64' || '--platform linux/amd64' }}

    steps:
      - uses: actions/checkout@v5.0.0
        with:
          fetch-depth: 0
          submodules: recursive

      #################################################################################################################
      ######################################## Prepare deps ###########################################################
      #################################################################################################################
      - name: Install deps
        uses: ./.github/actions/install-deps
        with:
          vulkan-version: ${{ env.VULKAN_VERSION }}

      #################################################################################################################
      ####################### Run unit/integration/fuzzy/coverage/tests/static analyzers ##############################
      #################################################################################################################
      - name: Set PRESET for compiler
        run: |
          if [ "${{ matrix.compiler }}" = "clang" ]; then
            echo "PRESET=linux-debug-clang" >> $GITHUB_ENV
          else
            echo "PRESET=linux-debug-GNU" >> $GITHUB_ENV
          fi

      - name: Prepare for unit/integration tests
        run: |
          . "/${{ env.VULKAN_VERSION }}/setup-env.sh"
          # Use relative path instead of absolute path
          cmake -B ${{ env.BUILD_DIR }} --preset "$PRESET"
          cmake --build ${{ env.BUILD_DIR }} --preset "$PRESET"
        working-directory: ${{ github.workspace }}

      - name: Run Unit/Integration tests
        working-directory: ${{ env.BUILD_DIR }}
        run: ctest -C ${{env.BUILD_TYPE}} --verbose --extra-verbose --debug -T test --output-on-failure -E Integration.VulkanEngine RendererTest.BasicSetup

      - name: Run fuzzer tests
        run: |
          if [ "${{ matrix.compiler }}" = "clang" ]; then
            ${{ env.BUILD_DIR }}/first_fuzz_test
          else
            echo "Compiled with GCC so no fuzz testing!"
          fi
        working-directory: ${{ github.workspace }}

      - name: Build Code Coverage
        run: |
          if [ "${{ matrix.compiler }}" = "gcc" ]; then
            gcovr -r .
          else
            llvm-profdata merge -sparse ${{ env.BUILD_DIR }}/Test/compile/default.profraw -o ${{ env.BUILD_DIR }}/compileTestSuite.profdata
            llvm-cov report ${{ env.BUILD_DIR }}/compileTestSuite -instr-profile=${{ env.BUILD_DIR }}/compileTestSuite.profdata
            llvm-cov export ${{ env.BUILD_DIR }}/compileTestSuite -format=text -instr-profile=${{ env.BUILD_DIR }}/compileTestSuite.profdata > ${{ env.COVERAGE_JSON }}
            llvm-cov show ${{ env.BUILD_DIR }}/compileTestSuite -instr-profile=${{ env.BUILD_DIR }}/compileTestSuite.profdata
          fi
        working-directory: ${{ github.workspace }}

      - name: Codecov
        if: ${{ matrix.compiler == 'clang' && inputs.runner == 'ubuntu-24.04' }}
        uses: codecov/codecov-action@v5.5.1
        with:
          token: ${{ secrets.CODECOV_TOKEN }}
          files: ${{ env.COVERAGE_JSON }}
          name: codecov-umbrella
          fail_ci_if_error: false
          verbose: false

      # runs for ever so disable
      #- name: Run clang tidy
      #  continue-on-error: true
      #  run: clang-tidy -p=./${{ env.BUILD_DIR }}/compile_commands.json  $(find Src -name '*.cpp' -o -name '*.cc')

      - name: Run Clang static analysis (HTML)
        continue-on-error: true
        if: ${{ matrix.compiler == 'clang' }}
        run: |
          # HTML output (correct flag form)
          clang++ --analyze -DUSE_RUST=1 -Xanalyzer -analyzer-output=html $(find Src -name '*.cpp' -o -name '*.cc')
        working-directory: ${{ github.workspace }}

      - name: Run Clang static analysis (scan-build)
        continue-on-error: true
        if: ${{ matrix.compiler == 'clang' }}
        run: |
          mkdir -p scan-build-reports
          scan-build-21 -o scan-build-reports cmake --build ${BUILD_DIR} --preset "${CLANG_DEBUG_PRESET}"
        working-directory: ${{ github.workspace }}

      #################################################################################################################
      ############################# Now run on performance benchmarking/profiling #####################################
      #################################################################################################################
      - name: Configure/build CMake for Profiling (select preset by compiler)
        run: |
          rm -r "${{ env.BUILD_DIR }}"
          if [ "${{ matrix.compiler }}" = "gcc" ]; then
            PRESET="${GCC_PROFILE_PRESET}"
          else
            PRESET="${CLANG_PROFILE_PRESET}"
          fi
          echo "Using preset: ${PRESET}"
          # ${{ github.workspace }}
          . "/${{ env.VULKAN_VERSION }}/setup-env.sh"
          cmake -B "${{ env.BUILD_DIR }}" --preset "${PRESET}"
          cmake --build "${{ env.BUILD_DIR }}" --preset "${PRESET}"
        working-directory: ${{ github.workspace }}

      - name: Run performance benchmarks
        run: ${{ env.BUILD_DIR }}/perfTestSuite
        working-directory: ${{ github.workspace }}
        
      #################################################################################################################
      ######################################## Build docs #############################################################
      #################################################################################################################

      - name: Set Astral UV venv
        if: ${{ matrix.compiler == 'clang' && inputs.runner == 'ubuntu-24.04' }}
        run: |
          . "$HOME/.local/bin/env" 
          uv venv
        working-directory: ${{ github.workspace }}

      # You can test your matrix by printing the current Python version
      - name: Setup python env
        if: ${{ matrix.compiler == 'clang' && inputs.runner == 'ubuntu-24.04' }}
        run: |
          . "$HOME/.local/bin/env"
          . ".venv/bin/activate"
          uv pip install -r requirements.txt
        working-directory: ${{ github.workspace }}

      - name: Build web page
        if: ${{ matrix.compiler == 'clang' && inputs.runner == 'ubuntu-24.04' }}
        run: |
          . "$HOME/.local/bin/env"
          cp ${{ env.DOCS_OUT }}/*.svg ./docs/source/_static
          cd docs/source
          uv run python graphviz_generator.py 
          cd ..
          uv run make html
        working-directory: ${{ github.workspace }}

      - name: ðŸ“‚ Sync files to domain
        uses: SamKirkland/FTP-Deploy-Action@v4.3.6
        if: ${{ matrix.compiler == 'clang' && inputs.runner == 'ubuntu-24.04' }}
        with:
          server: ${{ secrets.SERVER }}
          username: ${{ secrets.USERNAME }}
          password: ${{ secrets.PW }}
          local-dir: "./docs/build/html/"

  #################################################################################################################
  ################################ Build and package release version ##############################################
  #################################################################################################################
  release_package:
    needs: [build_and_test,]
    runs-on: ${{ inputs.runner }}
    
    # Run this job inside the GHCR container:
    container:
      image: ghcr.io/kataglyphis/kataglyphis_beschleuniger:latest
      credentials:
        username: ${{ github.actor }}
        password: ${{ secrets.GHCR_PAT }}
      options: >-
        --user root
        ${{ contains(inputs.runner, 'arm') && '--platform linux/arm64' || '--platform linux/amd64' }}

    steps:
      - uses: actions/checkout@v5.0.0
        with:
          submodules: recursive
      
      #################################################################################################################
      ######################################## Prepare deps ###########################################################
      #################################################################################################################
      - name: Install deps
        uses: ./.github/actions/install-deps
        with:
          vulkan-version: ${{ env.VULKAN_VERSION }}
          
      - name: Configure/build CMake for Release
        run: |
          # ${{ github.workspace }}
          . "/${{ env.VULKAN_VERSION }}/setup-env.sh"
          cmake -B "${{ env.BUILD_RELEASE_DIR }}" --preset linux-release-clang
          cmake --build "${{ env.BUILD_RELEASE_DIR }}" --config Release
        working-directory: ${{ github.workspace }}

      - name: Package
        run: |
          # ${{ github.workspace }}
          . "/${{ env.VULKAN_VERSION }}/setup-env.sh"
          cmake --build "${{ env.BUILD_RELEASE_DIR }}" --target package
        working-directory: ${{ github.workspace }}

      - name: Upload Linux Packages (Clang only)
        uses: actions/upload-artifact@v4.6.2
        with:
          name: linux-packages
          path: |
            ${{ env.BUILD_RELEASE_DIR }}/*.tar.gz
            ${{ env.BUILD_RELEASE_DIR }}/*.tgz
            ${{ env.BUILD_RELEASE_DIR }}/*.deb
